<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F2C MCP Server - WebSocket Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8" x-data="websocketClient()">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold">F2C</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">MCP WebSocket Client</h1>
                        <p class="text-gray-600">ç­‰å¾…è¿œç¨‹æ¶ˆæ¯æ¥æ”¶</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div :class="{
                        'w-3 h-3 rounded-full': true,
                        'bg-green-500': status === 'connected',
                        'bg-yellow-500 animate-pulse': status === 'connecting',
                        'bg-red-500': status === 'disconnected'
                    }"></div>
                    <span class="text-sm text-gray-600" x-text="statusText"></span>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-900">æ¶ˆæ¯å†å²</h2>
                <button @click="clearMessages()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-1 px-3 rounded-md transition-colors text-sm">
                    æ¸…ç©º
                </button>
            </div>
            
            <div class="h-96 overflow-y-auto bg-gray-50 rounded-md p-4 space-y-2">
                <template x-if="messages.length === 0">
                    <div class="text-gray-500 text-center py-8">ç­‰å¾…æ¶ˆæ¯...</div>
                </template>
                
                <template x-for="(message, index) in messages" :key="index">
                    <div :class="{
                        'p-3 rounded-md': true,
                        'bg-blue-100 text-blue-800': message.type === 'system',
                        'bg-green-100 text-green-800': message.type === 'response',
                        'bg-yellow-100 text-yellow-800': message.type === 'request',
                        'bg-red-100 text-red-800': message.type === 'error',
                        'bg-gray-100 text-gray-800': message.type === 'info'
                    }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1" x-html="message.content"></div>
                            <div class="text-xs opacity-75 ml-2" x-text="message.timestamp"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- æœ€æ–°æ¶ˆæ¯ä»£ç æ˜¾ç¤º -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6" x-show="latestCode">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">æœ€æ–°æ¥æ”¶çš„ä»£ç </h2>
            <div class="bg-gray-900 text-green-400 rounded-md p-4 font-mono text-sm overflow-x-auto">
                <pre class="whitespace-pre-wrap" x-text="latestCode"></pre>
            </div>
            <button @click="copyCode()" 
                    class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                å¤åˆ¶ä»£ç 
            </button>
        </div>
    </div>

    <script>
        function websocketClient() {
            return {
                ws: null,
                status: 'disconnected',
                statusText: 'æœªè¿æ¥',
                messages: [],
                latestCode: '',

                init() {
                    this.connect();
                },

                connect() {
                    this.status = 'connecting';
                    this.statusText = 'è¿æ¥ä¸­...';
                    
                    const wsUrl = `ws://${window.location.host}/ws?device=web`;
                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        this.status = 'connected';
                        this.statusText = 'å·²è¿æ¥';
                        this.addMessage('system', 'âœ… WebSocket è‡ªåŠ¨è¿æ¥æˆåŠŸ');
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleMessage(message);
                        } catch (error) {
                            this.addMessage('error', `æ¶ˆæ¯è§£æå¤±è´¥: ${error.message}`);
                        }
                    };

                    this.ws.onclose = () => {
                        this.status = 'disconnected';
                        this.statusText = 'è¿æ¥æ–­å¼€';
                        this.addMessage('system', 'âŒ WebSocket è¿æ¥æ–­å¼€');
                        
                        // 5ç§’åè‡ªåŠ¨é‡è¿
                        setTimeout(() => {
                            if (this.status === 'disconnected') {
                                this.addMessage('system', 'ğŸ”„ å°è¯•è‡ªåŠ¨é‡è¿...');
                                this.connect();
                            }
                        }, 5000);
                    };

                    this.ws.onerror = () => {
                        this.addMessage('error', 'âŒ WebSocket è¿æ¥é”™è¯¯');
                    };
                },

                handleMessage(message) {
                    switch (message.type) {
                        case 'component_response':
                            this.addMessage('response', `âœ… æ”¶åˆ°ç»„ä»¶ä»£ç : ${message.componentName || 'æœªçŸ¥ç»„ä»¶'}`);
                            if (message.code) {
                                this.latestCode = message.code;
                                this.addMessage('info', `ğŸ“„ ä»£ç é•¿åº¦: ${message.code.length} å­—ç¬¦`);
                            }
                            break;
                        case 'component_request':
                            this.addMessage('request', `ğŸ¨ æ”¶åˆ°ç»„ä»¶è¯·æ±‚: ${message.componentName} (${message.framework}, ${message.style})`);
                            break;
                        case 'connection_established':
                            this.addMessage('system', `ğŸ”— è¿æ¥å·²å»ºç«‹ï¼Œå®¢æˆ·ç«¯ID: ${message.clientId || 'æœªçŸ¥'}`);
                            break;
                        default:
                            this.addMessage('info', `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ç±»å‹: ${message.type}`);
                            if (message.data) {
                                this.addMessage('info', `ğŸ“„ æ¶ˆæ¯å†…å®¹: ${JSON.stringify(message.data).substring(0, 100)}...`);
                            }
                            // æ”¶åˆ°æ³›åŒ–è¯·æ±‚åï¼ŒæŒ‰ requestId å›ä¼ ï¼ˆç‚¹å¯¹ç‚¹ï¼‰
                            // å¦‚æœæ˜¯ get_html_contentï¼Œè¿”å›å›ºå®šç¤ºä¾‹ HTML å†…å®¹
                            if (message.requestId && this.ws && this.ws.readyState === WebSocket.OPEN) {
                                let response;
                                if (message.type === 'get_html_content') {
                                    response = {
                                        type: 'get_html_content',
                                        requestId: message.requestId,
                                        data: { content: '<div class="flex flex-col items-center p-7 rounded-2xl">demo</div>' },
                                        timestamp: Date.now()
                                    };
                                } else {
                                    response = {
                                        type: message.type,
                                        requestId: message.requestId,
                                        data: message.data ?? message,
                                        timestamp: Date.now()
                                    };
                                }
                                try {
                                    this.ws.send(JSON.stringify(response));
                                    this.addMessage('response', `â†©ï¸ å·²å›ä¼ å“åº”: ${response.type}`);
                                } catch (error) {
                                    this.addMessage('error', `å“åº”å‘é€å¤±è´¥: ${error.message}`);
                                }
                            }
                    }
                },

                addMessage(type, content) {
                    const timestamp = new Date().toLocaleTimeString();
                    this.messages.unshift({
                        type,
                        content,
                        timestamp
                    });
                    
                    // åªä¿ç•™æœ€æ–°çš„50æ¡æ¶ˆæ¯
                    if (this.messages.length > 50) {
                        this.messages = this.messages.slice(0, 50);
                    }
                },

                clearMessages() {
                    this.messages = [];
                    this.latestCode = '';
                },

                copyCode() {
                    if (this.latestCode) {
                        navigator.clipboard.writeText(this.latestCode).then(() => {
                            this.addMessage('system', 'ğŸ“‹ ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        }).catch(() => {
                            this.addMessage('error', 'âŒ å¤åˆ¶å¤±è´¥');
                        });
                    }
                }
            }
        }
    </script>
</body>
</html>