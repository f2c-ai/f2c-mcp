<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>F2C MCP | The MCP For Chrome Plugin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Import Map for MCP SDK -->
  <script type="importmap">
    {
      "imports": {
        "@modelcontextprotocol/sdk/client/index.js": "https://esm.sh/@modelcontextprotocol/sdk@1.20.2/dist/esm/client/index?bundle",
        "@modelcontextprotocol/sdk/client/streamableHttp.js": "https://esm.sh/@modelcontextprotocol/sdk@1.20.2/dist/esm/client/streamableHttp?bundle"
      }
    }
  </script>
  <script>
    window.mcpDemo = function () {
        return {
          // MCP client
          mcpClient: null,
          mcpTransport: null,
          mcpStatus: 'disconnected',
          mcpStatusText: '',
          // WebSocket (simplified - removed complex logic)
          ws: null,
          wsStatus: 'disconnected',
          wsStatusText: 'WS æœªè¿æ¥',
          // UI state
          messages: [],
          latestText: '',
          componentName: 'ConvertedComponent',
          framework: 'react',
          styleMode: 'css',
          defaultHtml: '<div class="flex flex-col items-center p-7 rounded-2xl">demo</div>',

        init () {
          this.connectWS()
          setTimeout(() => this.connectMcp(), 200)
        },

        addMessage (type, content) {
          const timestamp = new Date().toLocaleTimeString()
          this.messages.unshift({ type, content, timestamp })
          if (this.messages.length > 50) this.messages = this.messages.slice(0, 50)
        },

        clearMessages () {
          this.messages = []
          this.latestText = ''
        },

        // MCP è¿æ¥
        async connectMcp () {
          if (this.mcpStatus === 'connecting') {
            this.addMessage('info', 'â³ MCP æ­£åœ¨è¿æ¥ï¼Œè¯·ç¨å€™')
            return
          }
          if (this.mcpClient) {
            this.addMessage('info', 'âœ… MCP å·²è¿æ¥ï¼Œä¸é‡å¤å»ºç«‹è¿æ¥')
            return
          }
          try {
            this.mcpStatus = 'connecting'
            this.mcpStatusText = 'MCP è¿æ¥ä¸­...'
            const endpoint = new URL('/mcp', window.location.origin)

            const { Client, StreamableHTTPClientTransport } = await window.loadMcpSdk()
            const transport = new StreamableHTTPClientTransport(endpoint)
            const client = new Client(
              { name: 'web-demo', version: '1.0.0' },
              { capabilities: {} }
            )

            await client.connect(transport)
            this.mcpTransport = transport
            this.mcpClient = client
            this.mcpStatus = 'connected'
            this.mcpStatusText = 'MCP å·²è¿æ¥'
            this.addMessage('system', 'âœ… MCP å®¢æˆ·ç«¯è¿æ¥æˆåŠŸ')

            const tools = await client.listTools()
            const toolNames = Array.isArray(tools?.tools) ? tools.tools.map(t => t.name).join(', ') : 'æœªçŸ¥'
            this.addMessage('info', `ğŸ§° å¯ç”¨å·¥å…·: ${toolNames}`)
          } catch (error) {
            this.mcpStatus = 'disconnected'
            this.mcpStatusText = ''
            this.addMessage('error', `MCP è¿æ¥å¤±è´¥: ${error?.message || error}`)
          }
        },


        // è°ƒç”¨å·¥å…·è¿›è¡Œç»„ä»¶è½¬æ¢
        async requestConvert () {
          if (!this.mcpClient) {
            this.addMessage('error', 'è¯·å…ˆè¿æ¥ MCP')
            return
          }
          try {
            const args = {
              componentName: this.componentName || 'ConvertedComponent',
              framework: this.framework || 'react',
              style: this.styleMode || 'css'
            }
            this.addMessage('request', `ğŸ¨ è¯·æ±‚ç»„ä»¶è½¬æ¢: ${args.componentName} (${args.framework}, ${args.style})`)

            const result = await this.mcpClient.callTool({ 
              name: 'get_code_to_component', 
              arguments: args 
            })

            const text = result.content?.find?.(c => c.type === 'text')?.text || ''
            this.latestText = text
            this.addMessage('response', `âœ… æ”¶åˆ°è½¬æ¢æ–‡æœ¬ï¼Œé•¿åº¦: ${text.length} å­—ç¬¦`)
          } catch (error) {
            this.addMessage('error', `å·¥å…·è°ƒç”¨å¤±è´¥: ${error?.message || error}`)
          }
        },

        copyLatest () {
          if (!this.latestText) return
          navigator.clipboard.writeText(this.latestText)
            .then(() => this.addMessage('system', 'ğŸ“‹ å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
            .catch(() => this.addMessage('error', 'âŒ å¤åˆ¶å¤±è´¥'))
        },

        // WebSocket è¿æ¥ (ç®€åŒ–ç‰ˆ)
        connectWS () {
          this.wsStatus = 'connecting'
          this.wsStatusText = 'WS è¿æ¥ä¸­...'
          const wsUrl = `ws://${window.location.hostname}:${window.location.port || 3000}/ws?device=web`
          this.ws = new WebSocket(wsUrl)

          this.ws.onopen = () => {
            this.wsStatus = 'connected'
            this.wsStatusText = 'WS å·²è¿æ¥'
            this.addMessage('system', 'âœ… WebSocket è¿æ¥æˆåŠŸ')
          }

          this.ws.onmessage = (event) => {
            try {
              const message = JSON.parse(event.data)
              this.addMessage('info', `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${message.type}`)
              
              // ç®€åŒ–çš„æ¶ˆæ¯å¤„ç†
              if (message.requestId && this.ws && this.ws.readyState === WebSocket.OPEN) {
                const response = {
                  type: message.type,
                  requestId: message.requestId,
                  data: message.type === 'get_html_content' 
                    ? { content: this.defaultHtml }
                    : message.data,
                  timestamp: Date.now()
                }
                this.ws.send(JSON.stringify(response))
                this.addMessage('response', `â†©ï¸ å·²å›ä¼ å“åº”: ${response.type}`)
              }
            } catch (error) {
              this.addMessage('error', `æ¶ˆæ¯å¤„ç†å¤±è´¥: ${error?.message || error}`)
            }
          }

          this.ws.onclose = () => {
            this.wsStatus = 'disconnected'
            this.wsStatusText = 'WS è¿æ¥æ–­å¼€'
            this.addMessage('system', 'âŒ WebSocket è¿æ¥æ–­å¼€')
          }

          this.ws.onerror = () => {
            this.addMessage('error', 'âŒ WebSocket è¿æ¥é”™è¯¯')
          }
        },
        }
    }
  </script>
  <script src="https://unpkg.com/alpinejs" defer></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8" x-data="mcpDemo()">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold">F2C</span>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">MCP For Chrome Plugin</h1>
            <p class="text-gray-600">base @modelcontextprotocol/sdk</p>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <!-- MCP çŠ¶æ€ -->
          <div class="flex items-center space-x-2" x-show="mcpStatus !== 'disconnected'" title="MCP çŠ¶æ€">
            <div :class="{
              'w-3 h-3 rounded-full': true,
              'bg-green-500': mcpStatus === 'connected',
              'bg-yellow-500 animate-pulse': mcpStatus === 'connecting'
            }"></div>
            <span :class="{
              'text-green-500': mcpStatus === 'connected',
              'text-yellow-500 animate-pulse': mcpStatus === 'connecting'
            }" class="text-xl">ğŸ”Œ</span>
          </div>

          <!-- WebSocket çŠ¶æ€ -->
          <div class="flex items-center space-x-2" title="WebSocket çŠ¶æ€">
            <div :class="{
              'w-3 h-3 rounded-full': true,
              'bg-green-500': wsStatus === 'connected',
              'bg-yellow-500 animate-pulse': wsStatus === 'connecting',
              'bg-red-500': wsStatus === 'disconnected'
            }"></div>
            <span :class="{
              'text-green-500': wsStatus === 'connected',
              'text-yellow-500 animate-pulse': wsStatus === 'connecting',
              'text-red-500': wsStatus === 'disconnected'
            }" class="text-xl">ğŸ“¡</span>
          </div>
        </div>
      </div>
    </div>

    <!-- æ§ä»¶åŒº -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ç»„ä»¶å</label>
          <input type="text" class="w-full border rounded-md px-3 py-2" x-model="componentName" placeholder="ConvertedComponent" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ¡†æ¶</label>
          <select class="w-full border rounded-md px-3 py-2" x-model="framework">
            <option value="react">react</option>
            <option value="vue">vue</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ ·å¼</label>
          <select class="w-full border rounded-md px-3 py-2" x-model="styleMode">
            <option value="css">css</option>
            <option value="tailwind">tailwind</option>
          </select>
        </div>
      </div>

      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">é»˜è®¤ HTML å†…å®¹ï¼ˆç”¨äºå“åº” get_html_contentï¼‰</label>
        <textarea class="w-full border rounded-md px-3 py-2 font-mono text-sm" rows="6" x-model="defaultHtml"></textarea>
        <p class="text-xs text-gray-500 mt-1">å½“æœåŠ¡ç«¯é€šè¿‡ WebSocket è¯·æ±‚ <code>get_html_content</code> æ—¶ï¼Œä¼šè¿”å›æ­¤å†…å®¹ï¼›è‹¥ä¸ºç©ºå°†ä½¿ç”¨å†…ç½®é»˜è®¤å€¼ã€‚</p>
      </div>

      <div class="mt-4 flex items-center space-x-3">
        <button @click="requestConvert()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md">è¯·æ±‚ç»„ä»¶è½¬æ¢</button>
        <button @click="clearMessages()" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md">æ¸…ç©ºæ¶ˆæ¯</button>
      </div>
    </div>

    <!-- æ¶ˆæ¯æ˜¾ç¤º -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">History</h2>
      </div>
      <div class="h-96 overflow-y-auto bg-gray-50 rounded-md p-4 space-y-2">
        <template x-if="messages.length === 0">
          <div class="text-gray-500 text-center py-8">ç­‰å¾…æ¶ˆæ¯...</div>
        </template>
        <template x-for="(message, index) in messages" :key="index">
          <div :class="{
            'p-3 rounded-md': true,
            'bg-blue-100 text-blue-800': message.type === 'system',
            'bg-green-100 text-green-800': message.type === 'response',
            'bg-yellow-100 text-yellow-800': message.type === 'request',
            'bg-red-100 text-red-800': message.type === 'error',
            'bg-gray-100 text-gray-800': message.type === 'info'
          }">
            <div class="flex justify-between items-start">
              <div class="flex-1" x-html="message.content"></div>
              <div class="text-xs opacity-75 ml-2" x-text="message.timestamp"></div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- æœ€æ–°å†…å®¹æ˜¾ç¤º -->
    <div class="bg-white rounded-lg shadow-md p-6" x-show="latestText">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">MCP CALLBACK LLM Prompts</h2>
      <div class="bg-gray-900 text-green-400 rounded-md p-4 font-mono text-sm overflow-x-auto">
        <pre class="whitespace-pre-wrap" x-text="latestText"></pre>
      </div>
      <button @click="copyLatest()" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md">å¤åˆ¶å†…å®¹</button>
    </div>
  </div>

  <script type="module">
    // MCP SDK é€šè¿‡ import map æ˜ å°„åˆ° esm.shï¼Œä½¿ç”¨è£¸å¯¼å…¥å¹¶ç¼“å­˜ç»“æœ
    window.__mcpSdkPromise = window.__mcpSdkPromise || null
    window.loadMcpSdk = async () => {
      if (window.__mcpSdkPromise) return window.__mcpSdkPromise
      window.__mcpSdkPromise = (async () => {
        try {
          const i = await import('@modelcontextprotocol/sdk/client/index.js')
          const s = await import('@modelcontextprotocol/sdk/client/streamableHttp.js')
          const { Client } = i || {}
          const { StreamableHTTPClientTransport } = s || {}
          if (!Client || !StreamableHTTPClientTransport) {
            throw new Error('MCP SDK exports missing via import map')
          }
          return { Client, StreamableHTTPClientTransport }
        } catch (e) {
          console.error('MCP SDK import via import map failed:', e)
          throw e
        }
      })()
      return window.__mcpSdkPromise
    }
  </script>
</body>
</html>